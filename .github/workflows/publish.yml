name: Publish package to PyPI

on:
  release:
    types: [published]

jobs:
  run:
    name: Publish package
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    environment:
      name: pypi
    permissions:
      id-token: write   # mandatory for trusted publishing
      contents: read

    steps:
      - uses: actions/checkout@v6

      - name: Extract package name and version from tag
        id: tag
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          PACKAGE="${TAG%%/*}"
          VERSION="${TAG#*/}"

          echo "package=$PACKAGE" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          echo "Publishing $PACKAGE ($VERSION)"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install Python
        run: uv python install

      - name: Build the package
        working-directory: packages/${{ steps.tag.outputs.package }}
        run: uv build

      - name: Publish
        working-directory: packages/${{ steps.tag.outputs.package }}
        run: uv publish
